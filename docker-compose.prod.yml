# Production docker-compose for VPS deployment
# Uses pre-built image from GHCR
# Requires: warp service running on same network (see warp/docker-compose.yml)

services:
  openclaw-gateway:
    image: ghcr.io/bok-synapse/openclaw:latest
    container_name: openclaw-gateway
    restart: unless-stopped
    working_dir: /app
    environment:
      HOME: /home/node
      TERM: xterm-256color
      BROWSER: echo
      TZ: Asia/Kolkata
      # Proxy Jina traffic through Warp (separate compose, same network)
      HTTPS_PROXY: socks5://warp:1080
      HTTP_PROXY: socks5://warp:1080
      NO_PROXY: localhost,127.0.0.1,openclaw-gateway,caddy
      # OpenClaw config
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      OPENCLAW_GATEWAY_PASSWORD: ${OPENCLAW_GATEWAY_PASSWORD:-}
      OPENCLAW_GATEWAY_BIND: ${OPENCLAW_GATEWAY_BIND:-lan}
      # API keys
      DEEPGRAM_API_KEY: ${DEEPGRAM_API_KEY}
      TAVILY_API_KEY: ${TAVILY_API_KEY}
      EXA_API_KEY: ${EXA_API_KEY}
      JINA_API_KEY: ${JINA_API_KEY}
      # Custom API provider
      PROXY_BASE_URL: ${PROXY_BASE_URL}
      PROXY_API_KEY: ${PROXY_API_KEY}
      # WhatsApp allowlist
      PHONE_NUMBER: ${PHONE_NUMBER}
      # Baikal/vdirsyncer (for .fetch commands in config)
      BAIKAL_URL: ${BAIKAL_URL}
      BAIKAL_USERNAME: ${BAIKAL_USERNAME}
      BAIKAL_PASSWORD: ${BAIKAL_PASSWORD}
    volumes:
      - ./config/openclaw:/home/node/.openclaw
      - ./workspace:/home/node/claw
      - ./config/persistence:/persistence
    init: true
    command:
      - node
      - dist/index.js
      - gateway
      - --bind
      - ${OPENCLAW_GATEWAY_BIND:-lan}
      - --port
      - ${OPENCLAW_GATEWAY_PORT:-20663}
    networks:
      - caddy
    labels:
      caddy: ${URL}
      caddy.reverse_proxy: "{{upstreams 20663}}"
      caddy.reverse_proxy.header_up: "Host {host}"
      caddy.reverse_proxy.header_up_1: "X-Real-IP {remote_host}"
      caddy.reverse_proxy.header_up_2: "X-Forwarded-Proto https"
      caddy.reverse_proxy.flush_interval: "-1"
    healthcheck:
      test:
        - CMD
        - node
        - dist/index.js
        - health
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  openclaw-cli:
    image: ghcr.io/bok-synapse/openclaw:latest
    container_name: openclaw-cli
    profiles:
      - cli
    working_dir: /app
    environment:
      HOME: /home/node
      TERM: xterm-256color
      BROWSER: echo
      TZ: Asia/Kolkata
      OPENCLAW_GATEWAY_URL: ws://openclaw-gateway:20663
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      OPENCLAW_GATEWAY_PASSWORD: ${OPENCLAW_GATEWAY_PASSWORD:-}
      DEEPGRAM_API_KEY: ${DEEPGRAM_API_KEY}
      TAVILY_API_KEY: ${TAVILY_API_KEY}
      EXA_API_KEY: ${EXA_API_KEY}
      JINA_API_KEY: ${JINA_API_KEY}
      PROXY_BASE_URL: ${PROXY_BASE_URL}
      PROXY_API_KEY: ${PROXY_API_KEY}
      PHONE_NUMBER: ${PHONE_NUMBER}
      BAIKAL_URL: ${BAIKAL_URL}
      BAIKAL_USERNAME: ${BAIKAL_USERNAME}
      BAIKAL_PASSWORD: ${BAIKAL_PASSWORD}
    volumes:
      - ./config/openclaw:/home/node/.openclaw
      - ./workspace:/home/node/claw
      - ./config/persistence:/persistence
    stdin_open: true
    tty: true
    command:
      - node
      - dist/index.js
    networks:
      - caddy
    depends_on:
      openclaw-gateway:
        condition: service_healthy

networks:
  caddy:
    external: true
